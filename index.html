<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>DualPay Calculator 2030LN — Ресто (BGN / EUR)</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CDN (warning in console is normal for CDN use) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Manifest (relative path) -->
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-512.svg">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="DualPay Calculator">

  <meta name="description" content="DualPay Calculator — PWA за изчисляване на ресто в BGN и EUR при фиксиран курс 1.95583">

  <style>
    /* same styles as before (kept minimal) */
    :root{
      --accent: #0f5f73;
      --bg-gradient: linear-gradient(135deg, rgba(232,245,247,1) 0%, rgba(245,251,252,1) 100%);
      --tile: #f5d784;
      --muted: #6b7280;
      --rate: 1.95583;
    }
    html,body,#app { height:100%; }
    body {
      font-family: 'Montserrat', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: var(--bg-gradient);
      margin:0; padding:1.2rem;
    }
    .app-window { max-width:520px; margin:auto; border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.45));
      box-shadow: 0 10px 30px rgba(10,20,30,0.12); backdrop-filter: blur(10px) saturate(110%); overflow:hidden; }
    .app-header{ display:flex; gap:.75rem; align-items:center; padding:1rem; }
    .logo-tile{ width:52px; height:52px; border-radius:12px; background:var(--tile); display:flex; align-items:center; justify-content:center;
      font-family:'Comfortaa'; color:var(--accent); font-weight:700; font-size:18px; box-shadow:0 6px 18px rgba(15,95,115,0.12); }
    .small-muted{ font-size:0.82rem; color:var(--muted); }
    .pattern{ position:absolute; inset:0; pointer-events:none; z-index:0; opacity:0.08; color:#394047; display:grid; grid-template-columns: repeat(12, 1fr); gap:.5rem; padding:2rem; mix-blend-mode:multiply; }
    .pattern span{ display:block; text-align:center; font-size:18px; transform-origin:center; animation: float 8s ease-in-out infinite; }
    @keyframes float { 0%{transform:translateY(0);} 50%{transform:translateY(-6px) translateX(4px) rotate(2deg) scale(1.03);} 100%{transform:translateY(0);} }
    .card{ padding:1rem; position:relative; z-index:2; }
    .input{ background: rgba(255,255,255,0.7); border-radius:12px; padding:.65rem .75rem; display:flex; gap:.5rem; align-items:center; box-shadow:0 6px 16px rgba(12,18,24,0.06); border:1px solid rgba(8,12,15,0.04); }
    .result{ transition: all .28s cubic-bezier(.2,.9,.2,1); transform-origin:top; overflow:hidden; }
    .hidden-result{ opacity:0; max-height:0; transform:translateY(-6px); }
    .show-result{ opacity:1; max-height:300px; transform:translateY(0); }
    .segmented{ display:inline-flex; background: rgba(10,20,20,0.04); padding:4px; border-radius:10px; }
    .segmented button{ padding:6px 12px; border-radius:8px; border:none; font-weight:600; cursor:pointer; font-size:.95rem; }
    .segmented .active{ background:var(--accent); color:white; box-shadow:0 4px 12px rgba(11,55,60,0.18); }
    .error{ background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:.6rem; border-radius:10px; font-weight:600; }
    footer{ font-size:.82rem; color:var(--muted); padding:.8rem 1rem; text-align:center; border-top:1px dashed rgba(8,12,15,0.04); }
    @media (max-width:420px){ body{ padding:.9rem; } .logo-tile{ width:48px;height:48px;font-size:16px; } }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen flex items-center justify-center relative">
    <div class="pattern" aria-hidden="true" id="pattern"></div>

    <div class="app-window w-full max-w-md relative" role="application" aria-label="DualPay Calculator">
      <div class="app-header">
        <div class="logo-tile" aria-hidden="true">€лв</div>
        <div>
          <div class="app-title">DualPay Calculator 2030LN</div>
          <div class="small-muted">Ресто в BGN и EUR — Курс фиксиран: 1.95583</div>
        </div>
        <div style="margin-left:auto; display:flex; gap:0.5rem;">
          <button id="installBtn" class="px-3 py-1 rounded-md text-sm font-semibold border border-transparent text-white" style="background:var(--accent);">Инсталирай</button>
        </div>
      </div>

      <div class="card">
        <label class="small-muted mb-1 block">Сума за плащане</label>
        <div class="input mb-3" style="background: rgba(227,243,247,0.85);">
          <input id="amount" inputmode="decimal" type="number" step="0.01" min="0" placeholder="0.00" class="w-full bg-transparent outline-none text-2xl font-semibold" aria-label="Сума за плащане">
          <select id="amountCurrency" class="currency-select" aria-label="Валута за сумата">
            <option value="BGN">BGN</option>
            <option value="EUR" selected>EUR</option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-3">
          <div>
            <label class="small-muted mb-1 block">Платено в лв</label>
            <div class="input">
              <input id="paidBgn" inputmode="decimal" type="number" step="0.01" min="0" placeholder="0.00" class="w-full bg-transparent outline-none" aria-label="Платено в лева">
              <div class="small-muted">лв</div>
            </div>
          </div>
          <div>
            <label class="small-muted mb-1 block">Платено в €</label>
            <div class="input">
              <input id="paidEur" inputmode="decimal" type="number" step="0.01" min="0" placeholder="0.00" class="w-full bg-transparent outline-none" aria-label="Платено в евро">
              <div class="small-muted">€</div>
            </div>
          </div>
        </div>

        <div class="mb-3 flex items-center justify-between">
          <div class="small-muted">Покажи рестото като</div>
          <div class="segmented" role="tablist" aria-label="Избор на валута за рестото">
            <button id="showEur" class="active" role="tab" aria-selected="true">EUR</button>
            <button id="showBgn" role="tab" aria-selected="false">BGN</button>
          </div>
        </div>

        <div id="resultPanel" class="result hidden-result">
          <div id="errorBox" class="error mb-3 hidden">Недостатъчна платена сума</div>
          <div class="input mb-3">
            <div>
              <div class="small-muted">Ресто</div>
              <div id="changeMain" class="text-2xl font-bold">0.00 EUR</div>
              <div id="changeSecondary" class="small-muted">0.00 BGN</div>
            </div>
            <div style="margin-left:auto; display:flex; align-items:center;">
              <button id="copyChange" class="px-3 py-2 rounded-md text-sm font-semibold border border-transparent text-white" style="background:var(--accent);">Копирай</button>
            </div>
          </div>
        </div>

      </div>

      <footer>Курс: 1 EUR = 1.95583 BGN • © Николай Колев</footer>
    </div>
  </div>

  <script>
  (function(){
    const RATE = 1.95583;
    const amountEl = document.getElementById('amount');
    const amountCurrencyEl = document.getElementById('amountCurrency');
    const paidBgnEl = document.getElementById('paidBgn');
    const paidEurEl = document.getElementById('paidEur');
    const resultPanel = document.getElementById('resultPanel');
    const errorBox = document.getElementById('errorBox');
    const changeMain = document.getElementById('changeMain');
    const changeSecondary = document.getElementById('changeSecondary');
    const showEurBtn = document.getElementById('showEur');
    const showBgnBtn = document.getElementById('showBgn');
    const installBtn = document.getElementById('installBtn');
    const copyBtn = document.getElementById('copyChange');
    const pattern = document.getElementById('pattern');
    let displayCurrency = 'EUR';
    let deferredPrompt = null;

    // background pattern
    const symbols = ['€','лв','€','лв','€','лв','€','лв','€','лв','€','лв'];
    symbols.forEach((s,i)=>{ const sp = document.createElement('span'); sp.textContent = s; sp.style.animationDelay = (i%3)*0.6 + 's'; pattern.appendChild(sp); });

    function toFloat(v){ const n = parseFloat(String(v).replace(',', '.')); return isNaN(n) ? 0 : n; }

    function computeAndShow(){
      const amount = toFloat(amountEl.value);
      const amountCurrency = amountCurrencyEl.value;
      const paidBgn = toFloat(paidBgnEl.value);
      const paidEur = toFloat(paidEurEl.value);
      const amountEur = (amountCurrency === 'BGN') ? (amount / RATE) : amount;
      const paidTotalEur = paidEur + (paidBgn / RATE);
      const changeEur = +(paidTotalEur - amountEur).toFixed(6);

      if (amount === 0 && paidBgn === 0 && paidEur === 0) {
        resultPanel.classList.remove('show-result'); resultPanel.classList.add('hidden-result'); return;
      } else { resultPanel.classList.remove('hidden-result'); resultPanel.classList.add('show-result'); }

      if (changeEur < 0) {
        errorBox.classList.remove('hidden'); errorBox.textContent = 'Недостатъчна платена сума';
        changeMain.textContent = `- ${Math.abs(changeEur).toFixed(2)} EUR`;
        changeSecondary.textContent = `${(changeEur * RATE).toFixed(2)} BGN`;
        return;
      } else { errorBox.classList.add('hidden'); }

      if (displayCurrency === 'EUR') {
        changeMain.textContent = `${changeEur.toFixed(2)} EUR`;
        changeSecondary.textContent = `${(changeEur * RATE).toFixed(2)} BGN`;
      } else {
        const changeBgn = +(changeEur * RATE).toFixed(6);
        changeMain.textContent = `${changeBgn.toFixed(2)} BGN`;
        changeSecondary.textContent = `${(changeBgn / RATE).toFixed(2)} EUR`;
      }
    }

    showEurBtn.addEventListener('click', ()=>{ displayCurrency='EUR'; setActiveSegment(); });
    showBgnBtn.addEventListener('click', ()=>{ displayCurrency='BGN'; setActiveSegment(); });
    function setActiveSegment(){ if(displayCurrency==='EUR'){ showEurBtn.classList.add('active'); showBgnBtn.classList.remove('active'); } else { showBgnBtn.classList.add('active'); showEurBtn.classList.remove('active'); } computeAndShow(); }

    [amountEl, amountCurrencyEl, paidBgnEl, paidEurEl].forEach(el => { el.addEventListener('input', computeAndShow); el.addEventListener('change', computeAndShow); });

    copyBtn.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(changeMain.textContent); copyBtn.textContent = 'Копирано!'; setTimeout(()=>copyBtn.textContent='Копирай',1400); }
      catch(e){ copyBtn.textContent='Неуспешно'; setTimeout(()=>copyBtn.textContent='Копирай',1400); }
    });

    // Install prompt
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installBtn.style.display='inline-block'; });
    installBtn.addEventListener('click', async ()=> {
      if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; deferredPrompt = null; }
      else alert('За да инсталирате: използвайте "Add to Home Screen" в менюто на браузъра.');
    });

    // Register Service Worker — use relative path so scope is repo-root when on GitHub Pages
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(() => console.log('Service worker registered.'))
        .catch(err => console.warn('SW register failed:', err));
    }

    amountEl.focus(); computeAndShow(); setActiveSegment();
  })();
  </script>
</body>
</html>
